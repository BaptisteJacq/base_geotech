/*
TA_GEOTECH_SITE_LOG : Création de la table TA_GEOTECH_SITE_LOG regroupant toutes les actions effectuées sur sites géotechniques.
*/

-- 1. La table
CREATE TABLE G_GEOTECH.TA_GEOTECH_SITE_LOG (
    "OBJECTID" NUMBER(38,0) GENERATED BY DEFAULT AS IDENTITY,
    "ID_SITE" NUMBER(38,0),
    "GEOM" MDSYS.SDO_GEOMETRY,
    "CODE_INSEE" VARCHAR2(4000),
    "X_EPSG2154" NUMBER(38,6),
    "Y_EPSG2154" NUMBER(38,6),
    "DESCRIPTION" VARCHAR2(4000),
    "ADRESSE" VARCHAR2(4000),
    "DATE_ACTION" DATE,
    "FID_TYPE_ACTION" NUMBER(38,0),
    "PNOM" VARCHAR2(100)
 );

-- 2. Les commentaires
COMMENT ON TABLE G_GEOTECH.TA_GEOTECH_SITE_LOG IS 'Table  regroupant tous les sites géotechniques.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.OBJECTID IS 'Clé primaire auto-incrémentée de la table.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.ID_SITE IS 'Identifiant de chaque site.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.GEOM IS 'Champ géométrique de type ponctuel de chaque site.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.CODE_INSEE IS 'Code INSEE de la commune d''appartenance de chaque site.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.X_EPSG2154 IS 'Coordonnées en X de chaque site en Lambert93/RGF-93.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.Y_EPSG2154 IS 'Coordonnées en Y de chaque site en Lambert93/RGF-93.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.DESCRIPTION IS 'Description des études auxquelles chaque site est lié.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.ADRESSE IS 'Adresse de chaque site.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.DATE_ACTION IS 'Date d''insertion, modification ou suppression de site géotechnique.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.FID_TYPE_ACTION IS 'Clé étrangère vers la table TA_LIBELLE permettant de savoir quelle action a été effectuée sur le site.';
COMMENT ON COLUMN G_GEOTECH.TA_GEOTECH_SITE_LOG.PNOM IS 'Pnom de l''agent ayant effectué l''action.';

-- 3. Les métadonnées spatiales
INSERT INTO USER_SDO_GEOM_METADATA(
    TABLE_NAME, 
    COLUMN_NAME, 
    DIMINFO, 
    SRID
)
VALUES(
    'TA_GEOTECH_SITE_LOG',
    'GEOM',
    SDO_DIM_ARRAY(SDO_DIM_ELEMENT('X', 684540, 719822.2, 0.005),SDO_DIM_ELEMENT('Y', 7044212, 7078072, 0.005)), 
    2154
);
COMMIT;

-- 3. Les contraintes
-- Contrainte de clé primaire
ALTER TABLE G_GEOTECH.TA_GEOTECH_SITE_LOG
ADD CONSTRAINT TA_GEOTECH_SITE_LOG_PK
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE G_ADT_INDX;

-- Contrainte de clé étrangère
ALTER TABLE G_GEOTECH.TA_GEOTECH_SITE_LOG
ADD CONSTRAINT TA_GEOTECH_SITE_LOG_FID_TYPE_ACTION_FK
FOREIGN KEY("FID_TYPE_ACTION")
REFERENCES G_GEOTECH.TA_GEOTECH_LIBELLE("OBJECTID");

-- 4. Les index
-- Index spatial
CREATE INDEX TA_GEOTECH_SITE_LOG_SIDX
ON G_GEOTECH.TA_GEOTECH_SITE_LOG(GEOM)
INDEXTYPE IS MDSYS.SPATIAL_INDEX_V2
PARAMETERS('sdo_indx_dims=2, layer_gtype=POINT, tablespace=G_ADT_INDX, work_tablespace=DATA_TEMP');

-- Autres index
CREATE INDEX TA_GEOTECH_SITE_LOG_CODE_INSEE_IDX ON G_GEOTECH.TA_GEOTECH_SITE_LOG("CODE_INSEE")
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_GEOTECH_SITE_LOG_X_EPSG2154_IDX ON G_GEOTECH.TA_GEOTECH_SITE_LOG("X_EPSG2154")
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_GEOTECH_SITE_LOG_Y_EPSG2154_IDX ON G_GEOTECH.TA_GEOTECH_SITE_LOG("Y_EPSG2154")
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_GEOTECH_SITE_LOG_ADRESSE_IDX ON G_GEOTECH.TA_GEOTECH_SITE_LOG("ADRESSE")
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_GEOTECH_SITE_LOG_DESCRIPTION_IDX ON G_GEOTECH.TA_GEOTECH_SITE_LOG("DESCRIPTION")
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_GEOTECH_SITE_LOG_ACTION_IDX ON G_GEOTECH.TA_GEOTECH_SITE_LOG("FID_TYPE_ACTION", "PNOM", "DATE_ACTION")
    TABLESPACE G_ADT_INDX;

-- 5. Les droits de lecture, écriture, suppression
GRANT SELECT ON G_GEOTECH.TA_GEOTECH_SITE_LOG TO G_ADMIN_SIG;

/

